{"version":3,"sources":["../src/lib/build-registry.ts"],"sourcesContent":["import fs from 'fs/promises';\nimport path from 'path';\nimport { Registry } from '../schemas/registry-schema';\nimport { Item } from '../schemas/item-schema';\nimport { log, spinner } from '@clack/prompts';\nimport picocolors from 'picocolors';\nimport type { Setup } from '../schemas/setup-schema';\n\ninterface BuildRegistryOptions {\n  output: string;\n}\n\nexport async function buildRegistry(\n  registry: Registry,\n  options: BuildRegistryOptions,\n) {\n  const s = spinner();\n  s.start('Building registry...');\n\n  try {\n    // Build registry.json\n    await buildRegistryFile(registry, options.output);\n\n    // Build individual items\n    for (let i = 0; i < registry.items.length; i++) {\n      const item = registry.items[i];\n      s.message(`Building ${item.name} (${i + 1}/${registry.items.length})`);\n      await buildItem(item, options.output);\n    }\n\n    // Build setup if exists\n    if (registry.setup) {\n      s.message('Building setup configuration...');\n      await buildSetup(registry.setup, options.output);\n    }\n\n    s.stop('Build complete');\n    log.success(\n      picocolors.green(`Built ${registry.items.length} items successfully`),\n    );\n  } catch (error) {\n    s.stop('Build failed');\n    const message = error instanceof Error ? error.message : 'Unknown error';\n    log.error(picocolors.red(message));\n    process.exit(1);\n  }\n}\n\nasync function buildRegistryFile(\n  registry: Registry,\n  output: string,\n): Promise<void> {\n  // Remove file paths from registry.json (keep metadata only)\n  const cleanedItems = registry.items.map((item) => ({\n    ...item,\n    files: item.files.map(({ path: _, ...file }) => file),\n  }));\n\n  const cleanedRegistry = {\n    ...registry,\n    items: cleanedItems,\n  };\n\n  if (registry.setup) {\n    cleanedRegistry.setup = 'setup.json';\n  }\n\n  await fs.mkdir(output, { recursive: true });\n  await fs.writeFile(\n    path.join(output, 'registry.json'),\n    JSON.stringify(cleanedRegistry, null, 2),\n    'utf-8',\n  );\n}\n\nasync function buildItem(item: Item, output: string): Promise<void> {\n  const filesWithContent = await Promise.all(\n    item.files.map(async (file) => {\n      if (!file.path) {\n        throw new Error(`Path is required for file in item \"${item.name}\"`);\n      }\n\n      const content = await fs.readFile(file.path, 'utf-8');\n      const { path: _, ...rest } = file;\n\n      return {\n        ...rest,\n        content,\n      };\n    }),\n  );\n\n  const itemWithContent = {\n    ...item,\n    files: filesWithContent,\n  };\n\n  await fs.mkdir(output, { recursive: true });\n  await fs.writeFile(\n    path.join(output, `${item.name}.json`),\n    JSON.stringify(itemWithContent, null, 2),\n    'utf-8',\n  );\n}\n\nasync function buildSetup(setup: Setup, output: string): Promise<void> {\n  // Process setup steps and resolve contentPath\n  const processedSteps = await Promise.all(\n    setup.steps.map(async (step) => {\n      // Only process steps with contentPath\n      if (\n        'contentPath' in step &&\n        step.contentPath &&\n        (step.type === 'file-append' || step.type === 'file-create')\n      ) {\n        try {\n          const content = await fs.readFile(step.contentPath, 'utf-8');\n          const { contentPath: _, ...rest } = step;\n\n          return {\n            ...rest,\n            content,\n          };\n        } catch (error) {\n          throw new Error(\n            `Failed to read content for setup step from \"${step.contentPath}\": ${\n              error instanceof Error ? error.message : 'Unknown error'\n            }`,\n          );\n        }\n      }\n\n      return step;\n    }),\n  );\n\n  const processedSetup = {\n    steps: processedSteps,\n  };\n\n  await fs.writeFile(\n    path.join(output, 'setup.json'),\n    JSON.stringify(processedSetup, null, 2),\n    'utf-8',\n  );\n}\n\nasync function processSetupPaths(setup: Setup): Promise<Setup> {\n  const processedSteps = setup.steps.map((step) => {\n    if ('contentPath' in step && step.contentPath) {\n      const { contentPath: _, content: __, ...rest } = step as any;\n      return rest;\n    }\n\n    if ('content' in step && step.content) {\n      const { content: _, ...rest } = step as any;\n      return rest;\n    }\n\n    return step;\n  });\n\n  return {\n    steps: processedSteps,\n  };\n}\n"],"mappings":"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","names":[]}